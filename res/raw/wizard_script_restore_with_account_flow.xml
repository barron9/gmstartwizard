<?xml version="1.0" encoding="UTF-8"?>
<!-- Copyright (C) 2015 Google Inc. All Rights Reserved. -->

<!--
    The wizard:uris recorded here have the inconvenience of being generated by hand, but they allow
    for the full spread of launch flags (we need FLAG_ACTIVITY_NEW_TASK [0x10000000]), where the
    <intent> tag processed by Intent.parseIntent() does not.

    adb shell am to-intent-uri -a com.android.setupwizard.WELCOME -f 0x10000000 \-\-ez firstRun true
-->
<WizardScript xmlns:wizard="http://schemas.android.com/apk/res/com.google.android.setupwizard"
    wizard:firstAction="device_owner_warning">

    <!-- Security warning -->
    <WizardAction id="device_owner_warning"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.DEVICE_OWNER_WARNING;end">
        <result wizard:name="skip"
            wizard:resultCode="1"
            wizard:action="check_frp" />
        <result wizard:action="factory_reset" />
    </WizardAction>
    <WizardAction id="factory_reset"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.FACTORY_RESET;end">
        <!-- Factory reset should cause a reboot, but if it returns unexpectedly,
             continue on to check_frp -->
        <result wizard:action="check_frp" />
    </WizardAction>

    <WizardAction id="check_frp"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.CHECK_FRP;end">
        <result wizard:action="network_settings" />
    </WizardAction>

    <!-- Network -->
    <WizardAction id="network_settings"
        wizard:uri="intent:#Intent;action=com.android.setupwizard.NETWORK_SETTINGS;end">
        <result wizard:name="see_all_wifi"
            wizard:resultCode="101"
            wizard:action="wifi_settings" />
        <result wizard:name="use_cellular"
            wizard:resultCode="102"
            wizard:action="activate_mobile_data" />
        <result wizard:name="skip"
            wizard:resultCode="1"
            wizard:action="no_account_flow" />
        <result wizard:action="captive_portal" />
    </WizardAction>

    <WizardAction id="activate_mobile_data"
        wizard:uri="intent:#Intent;action=com.android.setupwizard.ACTIVATE_MOBILE_DATA;end">
        <result wizard:action="captive_portal" />
    </WizardAction>

    <!-- Wi-Fi setup -->
    <WizardAction id="wifi_settings"
        wizard:uri="intent:#Intent;action=com.android.setupwizard.WIFI_SETTINGS;end">
        <result wizard:action="captive_portal" />
    </WizardAction>

    <!-- Resolve captive portal access, and wait for check-in -->
    <WizardAction id="captive_portal"
        wizard:uri="intent:#Intent;action=com.android.setupwizard.CAPTIVE_PORTAL;end">
        <result wizard:action="gms_checkin" />
    </WizardAction>
    <WizardAction id="gms_checkin"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.GMS_CHECKIN;end">
        <result wizard:action="ota_update" />
    </WizardAction>

    <!-- Update important packages -->
    <WizardAction id="ota_update"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.OTA_UPDATE;end">
        <result wizard:name="skip"
            wizard:resultCode="1"
            wizard:action="early_update" />
        <result wizard:action="system_update" />
    </WizardAction>
    <WizardAction id="system_update"
        wizard:uri="intent:#Intent;action=android.settings.SYSTEM_UPDATE_SETTINGS;end">
        <!-- System update should cause a reboot, but if it returns unexpectedly, continue on to
            early update -->
        <result wizard:action="early_update" />
    </WizardAction>

    <WizardAction id="early_update"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.EARLY_UPDATE;end">
        <result wizard:action="load_account_intent" />
    </WizardAction>
    <WizardAction id="load_account_intent"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.LOAD_ADD_ACCOUNT_INTENT;B.showTapAndGo=false;end">
        <result wizard:action="account_setup" />
    </WizardAction>

    <!-- Add an account -->
    <WizardAction id="account_setup"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.ACCOUNT_SETUP;end">
        <result wizard:name="skip"
            wizard:resultCode="1"
            wizard:action="no_account_flow" />
        <!-- Alternate flow if managed provisioning already set the user up -->
        <result wizard:name="dpm_user_complete"
            wizard:resultCode="111" />
        <result wizard:action="gms_account_checkin" />
    </WizardAction>

    <!-- Checkin with Gservices using account. If it fails, VPA will not be available. -->
    <WizardAction id="gms_account_checkin"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.GMS_ACCOUNT_CHECKIN;end">
        <result wizard:name="skip"
            wizard:resultCode="1"
            wizard:action="mfm_check" />
        <result wizard:action="start_vpa" />
    </WizardAction>
    <WizardAction id="start_vpa"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.START_VPA;end">
        <result wizard:action="mfm_check" />
    </WizardAction>

    <!-- Used to log how an account was added (MFM or regular add account) -->
    <WizardAction id="mfm_check"
        wizard:uri="intent:#Intent;action=com.google.android.setupwizard.ACCOUNT_CHECK;end">
        <result wizard:name="skip"
            wizard:resultCode="1"
            wizard:action="no_account_flow" />
        <result wizard:action="account_flow" />
    </WizardAction>

    <WizardAction id="account_flow"
        wizard:script="android.resource://com.android.gmsetupwizard/raw/wizard_script_account_flow" />

    <WizardAction id="no_account_flow"
        wizard:script="android.resource://com.android.gmsetupwizard/raw/wizard_script_no_account_flow" />

</WizardScript>
